# سیستم تشخیص چهره و حضور و غیاب

این پروژه شامل دو بخش اصلی است:

1. **get-face-data.py**: سرور مدیریت داده‌های چهره که در سرور راه‌اندازی می‌شود
2. **faceDetectionWithCamera.py**: برنامه تشخیص چهره که روی دستگاه‌های محلی راه‌اندازی می‌شود

## پیش‌نیازها

برای راه‌اندازی کامل سیستم، نیاز به موارد زیر دارید:

- Python 3.8 یا بالاتر
- سرور MySQL
- سرور Redis
- کتابخانه‌های مورد نیاز از فایل `requirements.txt`

## نصب و راه‌اندازی

### 1. نصب بسته‌های مورد نیاز

```bash
pip install -r requirements.txt
```

### 2. تنظیمات محیطی

**برای سرور get-face-data.py (سرور):**

متغیرهای محیطی زیر را تنظیم کنید:
```
REDIS_HOST=localhost  # آدرس سرور Redis
```

**برای faceDetectionWithCamera.py (دستگاه محلی):**

متغیرهای محیطی زیر را تنظیم کنید:
```
PYTHON_API_URL=https://a.networklearnzero.shop/python-api  # آدرس API سرور
MYSQL_HOST=localhost  # آدرس دیتابیس
MYSQL_DATABASE=proj  # نام دیتابیس
MYSQL_USER=root  # نام کاربری دیتابیس
MYSQL_PASSWORD=  # رمز عبور دیتابیس
REDIS_HOST=localhost  # آدرس سرور Redis
REDIS_PORT=6379  # پورت Redis
```

### 3. راه‌اندازی

**سرور (get-face-data.py):**
```bash
python get-face-data.py
```

**کلاینت (faceDetectionWithCamera.py):**
```bash
python faceDetectionWithCamera.py
```

## نحوه کارکرد

1. **آپلود تصاویر چهره به سرور:**
   - تصاویر چهره از طریق API به سرور `get-face-data.py` ارسال می‌شود.
   - تصاویر چهره در Redis ذخیره و مدل تشخیص چهره به‌روزرسانی می‌شود.

2. **تشخیص چهره در کلاینت:**
   - برنامه `faceDetectionWithCamera.py` به دوربین‌های متصل دسترسی پیدا می‌کند.
   - مدل تشخیص چهره و فایل‌های لیبل از سرور دریافت می‌شود.
   - چهره‌های شناسایی‌شده با مدل مقایسه و در صورت تشخیص، حضور فرد ثبت می‌شود.
   - هر 10 دقیقه یکبار مدل از سرور به‌روزرسانی می‌شود.

3. **ثبت حضور:**
   - در صورت تشخیص چهره، اطلاعات حضور در دیتابیس MySQL ثبت می‌شود.

## نکات مهم

- فایل‌های مدل (model.xml) و لیبل‌ها (label_mapping.json و labels_to_name.json) در سرور نگهداری می‌شوند.
- برنامه کلاینت این فایل‌ها را از سرور دریافت می‌کند و به‌صورت موقت در دستگاه محلی استفاده می‌کند.
- برای عملکرد صحیح تشخیص چهره، کتابخانه opencv-contrib-python باید نصب شده باشد.
- برای اضافه کردن دوربین‌های بیشتر، بخش `add_camera` در تابع `main` را در فایل `faceDetectionWithCamera.py` ویرایش کنید.

## محیط داکر

برای راه‌اندازی در محیط داکر، از فایل docker-compose.yml پروژه استفاده کنید. اطمینان حاصل کنید که سرویس‌های mysql و redis 
قبل از راه‌اندازی سرویس pythonserver در حال اجرا باشند.

## عیب‌یابی

- **خطای اتصال به سرور API**: آدرس `PYTHON_API_URL` را بررسی کنید.
- **خطای اتصال به دیتابیس**: تنظیمات اتصال به دیتابیس را بررسی کنید.
- **عدم تشخیص چهره**: اطمینان حاصل کنید که مدل به درستی از سرور دریافت شده و نور محیط کافی است.
- **ماژول cv2.face یافت نشد**: نصب opencv-contrib-python را بررسی کنید. 