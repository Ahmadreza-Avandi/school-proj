(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[277],{56896:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/profile",function(){return a(11109)}])},11109:function(e,t,a){"use strict";a.r(t);var r=a(85893),s=a(67294),o=a(18745),n=a(11032),i=a(14312),l=a(97182),c=a(96788),d=a(68573),h=a(60762),x=a(41796),p=a(60990),m=a(55895),u=a(52857),g=a(81873),j=a(71919),y=a(47407),f=a(19304),Z=a(7638),b=a(32200),w=a(84677),v=a(26541),P=a(84925),I=a(10018),C=a(33453),S=a(92365),R=a(40110),k=a(29952),W=a(96727),N=a(237),T=a(81220),E=a(71225),_=a(17193),z=a(83580),F=a(6459),D=a(44771),q=a(88148),B=a(17071),A=a(68963),O=a(86395),G=a(70838),H=a(98539),U=a(24961),J=a(11163),L=a(35862);t.default=()=>{let[e,t]=(0,s.useState)(!0),[a,X]=(0,s.useState)(!1),[M,K]=(0,s.useState)(!1),[Q,V]=(0,s.useState)({fullName:"",nationalCode:"",phoneNumber:"",role:"",className:"",reshte:"",grade:"",reshteImage:"",gradeImage:"",photo:""}),[Y,$]=(0,s.useState)({currentPassword:"",newPassword:"",confirmPassword:""}),[ee,et]=(0,s.useState)({open:!1,message:"",severity:"success"}),ea=(0,J.useRouter)(),er=(0,o.Z)(),[es,eo]=(0,s.useState)(!1),[en,ei]=(0,s.useState)(null),[el,ec]=(0,s.useState)(!1),ed=(0,s.useRef)(null),eh=(0,s.useRef)(null),[ex,ep]=(0,s.useState)(null);(0,s.useEffect)(()=>{(async()=>{t(!0);let e=localStorage.getItem("access_token");try{if(!e){ea.push("/login");return}let t=JSON.parse(atob(e.split(".")[1])).nationalCode,a=await fetch("http://localhost:3001/users/by-national-code/".concat(t),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}});if(!a.ok){localStorage.removeItem("access_token"),ea.push("/login");return}let r=await a.json(),s=await fetch("http://localhost:3001/roles/".concat(r.roleId),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}}),o="نقش نامشخص";s.ok&&(o=(await s.json()).name);let n="";if(r.classId){let t=await fetch("http://localhost:3001/classes/".concat(r.classId),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}});t.ok&&(n=(await t.json()).name)}let i="",l="";if(r.reshteId){let t=await fetch("http://localhost:3001/reshte/".concat(r.reshteId),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();i=e.name,l=e.imageUrl||""}}let c="",d="";if(r.gradeId){let t=await fetch("http://localhost:3001/grades/".concat(r.gradeId),{method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)}});if(t.ok){let e=await t.json();c=e.name,d=e.imageUrl||""}}let h="https://photo-attendance-system.storage.c2.liara.space/user_register/".concat(r.nationalCode,".jpg?ts=").concat(Date.now());V({fullName:r.fullName,nationalCode:r.nationalCode,phoneNumber:r.phoneNumber,role:o,className:n,reshte:i,grade:c,reshteImage:l,gradeImage:d,photo:h})}catch(e){console.error("Error:",e),localStorage.removeItem("access_token"),ea.push("/login")}finally{t(!1)}})()},[ea]);let em=e=>{let{name:t,value:a}=e.target;V(e=>({...e,[t]:a}))},eu=e=>{let{name:t,value:a}=e.target;$(e=>({...e,[t]:a}))},eg=async e=>{e.preventDefault(),t(!0);let a=localStorage.getItem("access_token");try{(await fetch("http://localhost:3001/users/by-national-code/".concat(Q.nationalCode),{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)},body:JSON.stringify(Q)})).ok?(et({open:!0,message:"تغییرات با موفقیت ذخیره شد",severity:"success"}),X(!1)):et({open:!0,message:"خطا در به‌روزرسانی اطلاعات کاربر",severity:"error"})}catch(e){et({open:!0,message:"خطا در به‌روزرسانی اطلاعات کاربر",severity:"error"})}finally{t(!1)}},ej=async e=>{if(e.preventDefault(),Y.newPassword!==Y.confirmPassword){et({open:!0,message:"رمز عبور جدید و تکرار آن مطابقت ندارند",severity:"error"});return}t(!0);let a=localStorage.getItem("access_token");try{(await fetch("http://localhost:3001/users/change-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(a)},body:JSON.stringify({currentPassword:Y.currentPassword,newPassword:Y.newPassword})})).ok?(et({open:!0,message:"رمز عبور با موفقیت تغییر کرد",severity:"success"}),K(!1),$({currentPassword:"",newPassword:"",confirmPassword:""})):et({open:!0,message:"خطا در تغییر رمز عبور",severity:"error"})}catch(e){et({open:!0,message:"خطا در تغییر رمز عبور",severity:"error"})}finally{t(!1)}},ey=()=>{et({...ee,open:!1})},ef=async()=>{try{let e=await navigator.mediaDevices.getUserMedia({video:{width:720,height:720},audio:!1});ep(e),ec(!0),ed.current&&(ed.current.srcObject=e)}catch(e){console.error("Error accessing camera:",e),et({open:!0,message:"خطا در دسترسی به دوربین",severity:"error"})}},eZ=()=>{ex&&(ex.getTracks().forEach(e=>e.stop()),ep(null)),ec(!1)},eb=async()=>{if(!en)return;t(!0);let e=localStorage.getItem("access_token");try{let t=await fetch(en),a=await t.blob(),r=new FormData;if(r.append("photo",a,"".concat(Q.nationalCode,".jpg")),(await fetch("http://localhost:3001/users/upload-photo/".concat(Q.nationalCode),{method:"POST",headers:{Authorization:"Bearer ".concat(e)},body:r})).ok)V({...Q,photo:"".concat(Q.photo,"?ts=").concat(Date.now())}),et({open:!0,message:"عکس پروفایل با موفقیت به‌روزرسانی شد",severity:"success"}),ei(null),eo(!1);else throw Error("خطا در آپلود عکس")}catch(e){console.error("Error uploading photo:",e),et({open:!0,message:"خطا در آپلود عکس",severity:"error"})}finally{t(!1)}},ew=()=>{ei(null),eo(!1),ex&&(ex.getTracks().forEach(e=>e.stop()),ep(null))};return(0,r.jsxs)(n.Z,{maxWidth:"lg",sx:{mt:4,mb:4},children:[(0,r.jsx)(i.Z,{open:e,sx:{color:"#fff",zIndex:e=>e.zIndex.drawer+1},children:(0,r.jsx)(l.Z,{color:"inherit"})}),(0,r.jsxs)(L.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:[(0,r.jsx)(c.Z,{variant:"h4",component:"h1",gutterBottom:!0,sx:{mb:4,fontWeight:600,color:er.palette.primary.main,textAlign:"center"},children:"پروفایل کاربری"}),(0,r.jsxs)(d.ZP,{container:!0,spacing:4,children:[(0,r.jsx)(d.ZP,{item:!0,xs:12,md:4,children:(0,r.jsx)(L.E.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.5,delay:.2},children:(0,r.jsxs)(h.Z,{sx:{borderRadius:3,boxShadow:"0 8px 24px ".concat((0,x.Fq)(er.palette.primary.main,.15)),height:"100%",display:"flex",flexDirection:"column"},children:[(0,r.jsxs)(p.Z,{sx:{pt:3,pb:2,display:"flex",flexDirection:"column",alignItems:"center",bgcolor:(0,x.Fq)(er.palette.primary.main,.05),position:"relative"},children:[(0,r.jsxs)(p.Z,{sx:{position:"relative"},children:[(0,r.jsx)(m.Z,{src:Q.photo||"/no-avatar.png",alt:Q.fullName,sx:{width:120,height:120,bgcolor:er.palette.primary.main,mb:2,boxShadow:"0 0 15px ".concat((0,x.Fq)(er.palette.primary.main,.3))},onError:e=>{e.currentTarget.src="/no-avatar.png"},children:(0,r.jsx)(N.Z,{sx:{fontSize:70}})}),(0,r.jsx)(u.Z,{onClick:()=>eo(!0),sx:{position:"absolute",bottom:10,right:0,bgcolor:"rgba(255, 255, 255, 0.9)","&:hover":{bgcolor:"rgba(255, 255, 255, 1)"},boxShadow:"0 2px 10px rgba(0,0,0,0.2)"},children:(0,r.jsx)(T.Z,{fontSize:"small",color:"primary"})})]}),(0,r.jsx)(c.Z,{variant:"h5",gutterBottom:!0,sx:{fontWeight:600},children:Q.fullName}),(0,r.jsx)(g.Z,{label:Q.role,color:"primary",size:"medium",sx:{fontWeight:500}})]}),(0,r.jsx)(j.Z,{sx:{flexGrow:1},children:(0,r.jsxs)(y.Z,{children:[(0,r.jsxs)(f.ZP,{children:[(0,r.jsx)(Z.Z,{children:(0,r.jsx)(E.Z,{color:"primary"})}),(0,r.jsx)(b.Z,{primary:"کد ملی",secondary:Q.nationalCode,primaryTypographyProps:{fontWeight:500}})]}),(0,r.jsxs)(f.ZP,{children:[(0,r.jsx)(Z.Z,{children:(0,r.jsx)(_.Z,{color:"primary"})}),(0,r.jsx)(b.Z,{primary:"شماره تلفن",secondary:Q.phoneNumber,primaryTypographyProps:{fontWeight:500}})]}),Q.className&&(0,r.jsxs)(f.ZP,{children:[(0,r.jsx)(Z.Z,{children:(0,r.jsx)(z.Z,{color:"primary"})}),(0,r.jsx)(b.Z,{primary:"کلاس",secondary:Q.className,primaryTypographyProps:{fontWeight:500}})]}),Q.grade&&(0,r.jsxs)(f.ZP,{children:[(0,r.jsx)(Z.Z,{children:(0,r.jsx)(F.Z,{color:"primary"})}),(0,r.jsx)(b.Z,{primary:"پایه تحصیلی",secondary:Q.grade,primaryTypographyProps:{fontWeight:500}})]}),Q.reshte&&(0,r.jsxs)(f.ZP,{children:[(0,r.jsx)(Z.Z,{children:(0,r.jsx)(F.Z,{color:"primary"})}),(0,r.jsx)(b.Z,{primary:"رشته تحصیلی",secondary:Q.reshte,primaryTypographyProps:{fontWeight:500}})]})]})})]})})}),(Q.reshteImage||Q.gradeImage)&&(0,r.jsx)(d.ZP,{item:!0,xs:12,children:(0,r.jsx)(L.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.5},children:(0,r.jsx)(h.Z,{sx:{borderRadius:3,boxShadow:"0 8px 24px ".concat((0,x.Fq)(er.palette.primary.main,.15)),mb:4},children:(0,r.jsxs)(j.Z,{children:[(0,r.jsxs)(c.Z,{variant:"h6",sx:{fontWeight:600,mb:3,display:"flex",alignItems:"center"},children:[(0,r.jsx)(F.Z,{sx:{mr:1}})," تصاویر رشته و پایه تحصیلی"]}),(0,r.jsxs)(d.ZP,{container:!0,spacing:3,children:[Q.reshteImage&&(0,r.jsxs)(d.ZP,{item:!0,xs:12,md:6,children:[(0,r.jsxs)(c.Z,{variant:"subtitle1",gutterBottom:!0,sx:{fontWeight:500},children:["تصویر رشته: ",Q.reshte]}),(0,r.jsx)(p.Z,{component:"img",src:Q.reshteImage,alt:"تصویر رشته ".concat(Q.reshte),sx:{width:"100%",height:"auto",maxHeight:"300px",objectFit:"contain",borderRadius:2,boxShadow:"0 4px 12px ".concat((0,x.Fq)(er.palette.primary.main,.15))}})]}),Q.gradeImage&&(0,r.jsxs)(d.ZP,{item:!0,xs:12,md:6,children:[(0,r.jsxs)(c.Z,{variant:"subtitle1",gutterBottom:!0,sx:{fontWeight:500},children:["تصویر پایه تحصیلی: ",Q.grade]}),(0,r.jsx)(p.Z,{component:"img",src:Q.gradeImage,alt:"تصویر پایه تحصیلی ".concat(Q.grade),sx:{width:"100%",height:"auto",maxHeight:"300px",objectFit:"contain",borderRadius:2,boxShadow:"0 4px 12px ".concat((0,x.Fq)(er.palette.primary.main,.15))}})]})]})]})})})}),(0,r.jsx)(d.ZP,{item:!0,xs:12,md:8,children:(0,r.jsxs)(L.E.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{duration:.5,delay:.3},children:[(0,r.jsx)(h.Z,{sx:{borderRadius:3,boxShadow:"0 8px 24px ".concat((0,x.Fq)(er.palette.primary.main,.15)),mb:4},children:(0,r.jsxs)(j.Z,{children:[(0,r.jsxs)(p.Z,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[(0,r.jsxs)(c.Z,{variant:"h6",sx:{fontWeight:600,display:"flex",alignItems:"center"},children:[(0,r.jsx)(D.Z,{sx:{mr:1}})," اطلاعات شخصی"]}),(0,r.jsx)(w.Z,{variant:a?"outlined":"contained",onClick:()=>{X(!a)},startIcon:a?(0,r.jsx)(q.Z,{}):(0,r.jsx)(B.Z,{}),size:"small",sx:{borderRadius:2},children:a?"لغو":"ویرایش"})]}),(0,r.jsx)("form",{onSubmit:eg,children:(0,r.jsxs)(d.ZP,{container:!0,spacing:3,children:[(0,r.jsx)(d.ZP,{item:!0,xs:12,children:(0,r.jsx)(v.Z,{fullWidth:!0,label:"نام کامل",name:"fullName",value:Q.fullName,onChange:em,disabled:!a,variant:"outlined",InputProps:{sx:{borderRadius:2}}})}),(0,r.jsx)(d.ZP,{item:!0,xs:12,sm:6,children:(0,r.jsx)(v.Z,{fullWidth:!0,label:"کد ملی",name:"nationalCode",value:Q.nationalCode,disabled:!0,variant:"outlined",InputProps:{sx:{borderRadius:2}}})}),(0,r.jsx)(d.ZP,{item:!0,xs:12,sm:6,children:(0,r.jsx)(v.Z,{fullWidth:!0,label:"شماره تلفن",name:"phoneNumber",value:Q.phoneNumber,onChange:em,disabled:!a,variant:"outlined",InputProps:{sx:{borderRadius:2}}})}),a&&(0,r.jsx)(d.ZP,{item:!0,xs:12,children:(0,r.jsx)(w.Z,{type:"submit",variant:"contained",startIcon:(0,r.jsx)(A.Z,{}),fullWidth:!0,sx:{borderRadius:2,py:1.2,boxShadow:"0 4px 12px ".concat((0,x.Fq)(er.palette.primary.main,.3))},children:"ذخیره تغییرات"})})]})})]})}),(0,r.jsx)(L.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5,delay:.4},children:(0,r.jsx)(h.Z,{sx:{borderRadius:3,boxShadow:"0 8px 24px ".concat((0,x.Fq)(er.palette.primary.main,.15))},children:(0,r.jsxs)(j.Z,{children:[(0,r.jsxs)(p.Z,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[(0,r.jsxs)(c.Z,{variant:"h6",sx:{fontWeight:600,display:"flex",alignItems:"center"},children:[(0,r.jsx)(O.Z,{sx:{mr:1}})," تغییر رمز عبور"]}),(0,r.jsx)(w.Z,{variant:M?"outlined":"contained",onClick:()=>{K(!M),$({currentPassword:"",newPassword:"",confirmPassword:""})},startIcon:M?(0,r.jsx)(q.Z,{}):(0,r.jsx)(G.Z,{}),size:"small",sx:{borderRadius:2},children:M?"لغو":"تغییر رمز عبور"})]}),M&&(0,r.jsx)("form",{onSubmit:ej,children:(0,r.jsxs)(d.ZP,{container:!0,spacing:3,children:[(0,r.jsx)(d.ZP,{item:!0,xs:12,children:(0,r.jsx)(v.Z,{fullWidth:!0,label:"رمز عبور فعلی",name:"currentPassword",type:"password",value:Y.currentPassword,onChange:eu,variant:"outlined",InputProps:{sx:{borderRadius:2}},required:!0})}),(0,r.jsx)(d.ZP,{item:!0,xs:12,sm:6,children:(0,r.jsx)(v.Z,{fullWidth:!0,label:"رمز عبور جدید",name:"newPassword",type:"password",value:Y.newPassword,onChange:eu,variant:"outlined",InputProps:{sx:{borderRadius:2}},required:!0})}),(0,r.jsx)(d.ZP,{item:!0,xs:12,sm:6,children:(0,r.jsx)(v.Z,{fullWidth:!0,label:"تکرار رمز عبور جدید",name:"confirmPassword",type:"password",value:Y.confirmPassword,onChange:eu,variant:"outlined",InputProps:{sx:{borderRadius:2}},required:!0})}),(0,r.jsx)(d.ZP,{item:!0,xs:12,children:(0,r.jsx)(w.Z,{type:"submit",variant:"contained",startIcon:(0,r.jsx)(A.Z,{}),fullWidth:!0,sx:{borderRadius:2,py:1.2,boxShadow:"0 4px 12px ".concat((0,x.Fq)(er.palette.primary.main,.3))},children:"ثبت رمز عبور جدید"})})]})})]})})})]})})]})]}),(0,r.jsx)(P.Z,{open:ee.open,autoHideDuration:6e3,onClose:ey,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:(0,r.jsx)(I.Z,{onClose:ey,severity:ee.severity,variant:"filled",sx:{width:"100%",borderRadius:2},children:ee.message})}),(0,r.jsxs)(C.Z,{open:es,onClose:ew,fullWidth:!0,maxWidth:"sm",children:[(0,r.jsx)(S.Z,{sx:{fontWeight:600,textAlign:"center"},children:"تغییر عکس پروفایل"}),(0,r.jsx)(R.Z,{children:el?(0,r.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,r.jsx)(p.Z,{sx:{border:"1px solid #ddd",borderRadius:2,overflow:"hidden",mb:2,width:"100%",maxWidth:400,maxHeight:400},children:(0,r.jsx)("video",{ref:ed,autoPlay:!0,playsInline:!0,muted:!0,style:{width:"100%",height:"auto"}})}),(0,r.jsx)(w.Z,{variant:"contained",startIcon:(0,r.jsx)(H.Z,{}),onClick:()=>{if(ed.current&&eh.current){let e=ed.current,t=eh.current;t.width=e.videoWidth,t.height=e.videoHeight;let a=t.getContext("2d");a&&(a.drawImage(e,0,0,t.width,t.height),ei(t.toDataURL("image/jpeg")),eZ())}},sx:{borderRadius:2},children:"گرفتن عکس"})]}):en?(0,r.jsx)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:(0,r.jsx)(p.Z,{component:"img",src:en,alt:"عکس گرفته شده",sx:{maxWidth:"100%",maxHeight:400,borderRadius:2,mb:2,boxShadow:"0 4px 12px rgba(0,0,0,0.1)"}})}):(0,r.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center",py:3},children:[(0,r.jsx)(c.Z,{variant:"body1",gutterBottom:!0,children:"برای تغییر عکس پروفایل، یکی از گزینه‌های زیر را انتخاب کنید:"}),(0,r.jsxs)(p.Z,{sx:{display:"flex",justifyContent:"center",mt:2},children:[(0,r.jsx)(w.Z,{variant:"contained",startIcon:(0,r.jsx)(T.Z,{}),onClick:ef,sx:{borderRadius:2,mx:1},children:"گرفتن عکس با دوربین"}),(0,r.jsxs)("label",{htmlFor:"photo-upload",children:[(0,r.jsx)(k.Z,{id:"photo-upload",type:"file",inputProps:{accept:"image/*"},onChange:e=>{var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(a){let e=new FileReader;e.onload=e=>{var t;ei(null===(t=e.target)||void 0===t?void 0:t.result)},e.readAsDataURL(a)}},sx:{display:"none"}}),(0,r.jsx)(w.Z,{component:"span",variant:"outlined",startIcon:(0,r.jsx)(U.Z,{}),sx:{borderRadius:2,mx:1},children:"آپلود از کامپیوتر"})]})]})]})}),(0,r.jsx)(W.Z,{sx:{px:3,pb:3},children:en?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(w.Z,{onClick:ew,variant:"outlined",sx:{borderRadius:2},children:"لغو"}),(0,r.jsx)(w.Z,{onClick:eb,variant:"contained",startIcon:(0,r.jsx)(A.Z,{}),sx:{borderRadius:2},children:"ذخیره عکس"})]}):(0,r.jsx)(w.Z,{onClick:ew,variant:"outlined",sx:{borderRadius:2},children:"بستن"})})]}),(0,r.jsx)("canvas",{ref:eh,style:{display:"none"}})]})}}},function(e){e.O(0,[6838,9311,1349,8573,1873,5325,6393,9198,6678,2888,9774,179],function(){return e(e.s=56896)}),_N_E=e.O()}]);