(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2166],{74142:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/attendance",function(){return s(55653)}])},55653:function(e,t,s){"use strict";s.r(t);var n=s(85893),r=s(67294),a=s(18745),i=s(61730),l=s(60990),o=s(10018),c=s(93454),d=s(68573),u=s(6897),h=s(20646),x=s(45083),m=s(15972),j=s(97182),g=s(84166),p=s(48690),f=s(52857),Z=s(56912),b=s(81873),y=s(84677),v=s(25026),w=s(76592),S=s(70360),_=s(46577),z=s(8863),C=s(19827),k=s(84324),E=s(96788),N=s(84925),I=s(26278),T=s(4413),W=s.n(T),P=s(41153),O=s.n(P),R=s(6459),D=s(42158),Y=s(12034),H=s(15821),M=s(53819),F=s(38444),A=s(72877);t.default=()=>{let[e,t]=(0,r.useState)([]),[s,T]=(0,r.useState)(null),[P,L]=(0,r.useState)(new I.NT({calendar:W(),locale:O()})),[X,J]=(0,r.useState)(null),[G,U]=(0,r.useState)([]),[q,B]=(0,r.useState)(null),[K,Q]=(0,r.useState)([]),[V,$]=(0,r.useState)("present"),[ee,et]=(0,r.useState)(!1),[es,en]=(0,r.useState)(!1),[er,ea]=(0,r.useState)(!1),[ei,el]=(0,r.useState)(null),[eo,ec]=(0,r.useState)({open:!1,message:"",severity:"success"}),[ed,eu]=(0,r.useState)(null),eh=(0,a.Z)(),ex=(0,i.Z)(eh.breakpoints.down("sm")),em=(0,i.Z)(eh.breakpoints.down("md"));(0,r.useEffect)(()=>{let e=document.createElement("style");return e.innerHTML="\n      .rmdp-container {\n        direction: rtl;\n        width: 100%;\n      }\n      .date-picker-input {\n        width: 100%;\n        text-align: center;\n        font-family: inherit;\n      }\n      .rmdp-day, .rmdp-week-day {\n        font-family: inherit;\n      }\n    ",document.head.appendChild(e),()=>{document.head.removeChild(e)}},[]),(0,r.useEffect)(()=>{fetch("/api/add-subject-column",{method:"POST"}).then(e=>e.json()).then(e=>{console.log("Database structure check:",e)}).catch(e=>{console.error("Error checking database structure:",e)})},[]),(0,r.useEffect)(()=>{(async()=>{et(!0);try{let e=await fetch("/api/classes");if(!e.ok)throw Error("خطا در دریافت کلاس‌ها");let s=await e.json();t(s)}catch(e){console.error("Error fetching classes:",e),el("خطا در دریافت کلاس‌ها")}finally{et(!1)}})()},[]),(0,r.useEffect)(()=>{if(P){let e=P.format("YYYY/MM/DD");J(e=e.replace(/[۰-۹]/g,e=>String("۰۱۲۳۴۵۶۷۸۹".indexOf(e)))),s&&setTimeout(()=>ej(),100)}},[P]);let ej=async e=>{try{if(!s||!X){ec({open:!0,message:"لطفاً کلاس و تاریخ را انتخاب کنید",severity:"warning"});return}en(!0),el(null);let t="/api/attendance?classId=".concat(s.id,"&date=").concat(X),n=e||V;n&&(t+="&attendanceFilter=".concat(n)),q&&(t+="&subjectId=".concat(q.id)),console.log("Fetching attendance with URL:",t);let r=await fetch(t),a=await r.json();if(!r.ok)throw console.error("Server error response:",a),Error(a.message||"خطا در دریافت اطلاعات: ".concat(r.status));a&&a.students?(Q(a.students.map(e=>({...e,photo:"https://photo-attendance-system.storage.c2.liara.space/user_register/".concat(e.nationalCode,".jpg?ts=").concat(Date.now())}))),a.subjects&&a.subjects.length>0?(U(a.subjects),eu(a.dayOfWeek)):(U([]),B(null),eu(null)),0===a.students.length?ec({open:!0,message:"دانش آموزی در این فیلتر یافت نشد",severity:"info"}):eo.open&&"دانش آموزی در این فیلتر یافت نشد"===eo.message&&ec({open:!1,message:"",severity:"success"})):(Q([]),ec({open:!0,message:"ساختار داده‌های دریافتی نامعتبر است",severity:"error"}))}catch(e){console.error("Error fetching attendance data:",e),el(e instanceof Error?e.message:"خطا در دریافت اطلاعات حضور و غیاب"),ec({open:!0,message:e instanceof Error?e.message:"خطا در دریافت اطلاعات حضور و غیاب",severity:"error"}),Q([])}finally{en(!1)}},eg=async e=>{try{let t="present"===e.status?"absent":"present",s={id:e.id,status:t,userId:e.userId,nationalCode:e.nationalCode,fullName:e.fullName,className:e.className,jalali_date:X,dayOfWeek:ed,subjectId:(null==q?void 0:q.id)||null};console.log("Sending data to update attendance:",s);let n=await fetch("/api/attendance",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!n.ok){let e=await n.json();throw Error(e.message||"خطا در بروزرسانی وضعیت حضور")}let r=await n.json();console.log("Response from server:",r),Q(s=>s.map(s=>s.nationalCode===e.nationalCode?{...s,status:t,id:r.id}:s)),setTimeout(()=>ej(),500),ec({open:!0,message:"وضعیت حضور ".concat(e.fullName," به ").concat("present"===t?"حاضر":"غایب"," تغییر کرد"),severity:"success"})}catch(e){console.error("Error toggling attendance status:",e),ec({open:!0,message:e instanceof Error?e.message:"خطا در بروزرسانی وضعیت حضور",severity:"error"})}},ep=e=>{$(e),ej(e)},ef=()=>{ec({...eo,open:!1})},eZ=async()=>{if(!s||!X){ec({open:!0,message:"لطفاً کلاس و تاریخ را انتخاب کنید",severity:"warning"});return}try{ea(!0);let e=await fetch("/api/students-by-class?classId=".concat(s.id));if(!e.ok)throw Error("خطا در دریافت لیست دانش‌آموزان");for(let t of(await e.json())){let e={id:0,status:"present",userId:t.id,nationalCode:t.nationalCode,fullName:t.fullName,classId:s.id,className:s.name,jalali_date:X,dayOfWeek:ed,subjectId:(null==q?void 0:q.id)||null};await fetch("/api/attendance",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}ej(),ec({open:!0,message:"حضور همه دانش‌آموزان با موفقیت ثبت شد",severity:"success"})}catch(e){console.error("Error marking all students present:",e),ec({open:!0,message:e instanceof Error?e.message:"خطا در ثبت حضور گروهی",severity:"error"})}finally{ea(!1)}};return(0,n.jsxs)(l.Z,{px:ex?1:3,py:2,children:[ei&&(0,n.jsx)(o.Z,{severity:"error",sx:{mb:2},children:ei}),(0,n.jsx)(c.Z,{sx:{p:2,mb:3,borderRadius:2},children:(0,n.jsxs)(d.ZP,{container:!0,spacing:2,alignItems:"center",children:[(0,n.jsx)(d.ZP,{item:!0,xs:12,md:4,children:(0,n.jsxs)(l.Z,{sx:{display:"flex",alignItems:"center"},children:[(0,n.jsx)(R.Z,{sx:{color:"primary.main",mr:1}}),(0,n.jsxs)(u.Z,{fullWidth:!0,size:ex?"small":"medium",children:[(0,n.jsx)(h.Z,{id:"class-select-label",children:"کلاس"}),(0,n.jsx)(x.Z,{labelId:"class-select-label",id:"class-select",value:s?s.id.toString():"",label:"کلاس",onChange:t=>{let s=t.target.value,n=e.find(e=>e.id.toString()===s);T(n||null),B(null),Q([]),X&&n&&setTimeout(()=>ej(),0)},children:ee?(0,n.jsxs)(m.Z,{value:"",disabled:!0,children:[(0,n.jsx)(j.Z,{size:20}),"در حال بارگذاری..."]}):e.length>0?e.map(e=>(0,n.jsx)(m.Z,{value:e.id.toString(),children:e.name},e.id)):(0,n.jsx)(m.Z,{value:"",disabled:!0,children:"هیچ کلاسی یافت نشد"})})]})]})}),(0,n.jsx)(d.ZP,{item:!0,xs:12,md:4,children:(0,n.jsxs)(g.Z,{direction:"row",spacing:1,alignItems:"center",children:[(0,n.jsx)(D.Z,{sx:{color:"primary.main"}}),(0,n.jsx)(l.Z,{sx:{flexGrow:1,display:"flex",position:"relative"},children:(0,n.jsx)(I.ZP,{calendar:W(),locale:O(),value:P,onChange:e=>{e&&L(e)},format:"YYYY/MM/DD",calendarPosition:"bottom-right",inputClass:"date-picker-input",containerStyle:{width:"100%"},style:{height:ex?"46px":"56px",width:"100%",boxSizing:"border-box",padding:ex?"12px 10px":"16.5px 14px",border:"1px solid rgba(0, 0, 0, 0.23)",borderRadius:"4px",fontFamily:"inherit",fontSize:ex?"0.9rem":"1rem"}})}),(0,n.jsx)(p.Z,{title:"امروز",children:(0,n.jsx)(f.Z,{onClick:()=>{L(new I.NT({calendar:W(),locale:O()}))},color:"primary",size:ex?"small":"medium",children:(0,n.jsx)(D.Z,{})})})]})}),(0,n.jsx)(d.ZP,{item:!0,xs:12,md:4,children:(0,n.jsxs)(l.Z,{sx:{display:"flex",alignItems:"center"},children:[(0,n.jsx)(Y.Z,{sx:{color:"primary.main",mr:2}}),(0,n.jsxs)(u.Z,{fullWidth:!0,size:ex?"small":"medium",children:[(0,n.jsxs)(h.Z,{id:"subject-select-label",children:["درس ",ed?"(".concat(ed,")"):""]}),(0,n.jsxs)(x.Z,{labelId:"subject-select-label",id:"subject-select",value:q?q.id.toString():"",label:"درس ".concat(ed?"(".concat(ed,")"):""),onChange:e=>{let t=e.target.value;""===t?B(null):B(G.find(e=>e.id.toString()===t)||null),setTimeout(()=>ej(),0)},disabled:!G.length,children:[(0,n.jsx)(m.Z,{value:"",children:(0,n.jsx)("em",{children:"همه دروس"})}),G.map(e=>(0,n.jsxs)(m.Z,{value:e.id.toString(),children:[e.name," (",e.startTime.substring(0,5),"-",e.endTime.substring(0,5),")"]},e.id))]})]})]})}),(0,n.jsx)(d.ZP,{item:!0,xs:12,children:(0,n.jsx)(Z.Z,{sx:{my:1},children:(0,n.jsx)(b.Z,{icon:(0,n.jsx)(H.Z,{}),label:"فیلتر",variant:"outlined",color:"primary",size:ex?"small":"medium"})})}),(0,n.jsx)(d.ZP,{item:!0,xs:12,children:(0,n.jsxs)(g.Z,{direction:{xs:"column",sm:"row"},spacing:2,justifyContent:"center",sx:{width:"100%"},children:[(0,n.jsx)(y.Z,{variant:"present"===V?"contained":"outlined",color:"success",onClick:()=>ep("present"),startIcon:(0,n.jsx)(M.Z,{}),fullWidth:ex,size:ex?"small":"medium",sx:{borderRadius:2},children:"حاضرین"}),(0,n.jsx)(y.Z,{variant:"absent"===V?"contained":"outlined",color:"error",onClick:()=>ep("absent"),startIcon:(0,n.jsx)(F.Z,{}),fullWidth:ex,size:ex?"small":"medium",sx:{borderRadius:2},children:"غایبین"}),(0,n.jsx)(y.Z,{variant:"outlined",color:"primary",onClick:eZ,disabled:er||!s||!X,startIcon:er?(0,n.jsx)(j.Z,{size:20}):(0,n.jsx)(M.Z,{}),fullWidth:ex,size:ex?"small":"medium",sx:{borderRadius:2},children:"ثبت حضور همه"})]})})]})}),(0,n.jsxs)(c.Z,{sx:{borderRadius:2,overflow:"hidden",boxShadow:eh.shadows[2],"& .MuiTableContainer-root":{overflowX:"auto",maxHeight:ex?"calc(100vh - 290px)":"calc(100vh - 320px)"}},children:[(0,n.jsx)(v.Z,{children:(0,n.jsxs)(w.Z,{stickyHeader:!0,size:ex?"small":"medium",children:[(0,n.jsx)(S.Z,{children:(0,n.jsxs)(_.Z,{children:[(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:ex?"0.8rem":"1rem"},children:"تصویر"}),(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:ex?"0.8rem":"1rem"},children:"نام"}),!ex&&(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:"1rem"},children:"کد ملی"}),!em&&(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:"1rem"},children:"کلاس"}),!q&&(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:ex?"0.8rem":"1rem"},children:"درس‌ها"}),q&&(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:ex?"0.8rem":"1rem"},children:"درس"}),(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:ex?"0.8rem":"1rem"},children:"ساعت حضور"}),(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:ex?"0.8rem":"1rem"},children:"وضعیت"}),(0,n.jsx)(z.Z,{align:"center",sx:{fontWeight:"bold",fontSize:ex?"0.8rem":"1rem"},children:"عملیات"})]})}),(0,n.jsx)(C.Z,{children:es?Array.from([,,,,,]).map((e,t)=>(0,n.jsxs)(_.Z,{children:[(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"circular",width:40,height:40})}),(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"text",width:"100%"})}),!ex&&(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"text",width:"100%"})}),!em&&(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"text",width:"100%"})}),!q&&(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"text",width:"100%"})}),q&&(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"text",width:"100%"})}),(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"text",width:80})}),(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"rounded",width:80,height:32})}),(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(k.Z,{variant:"circular",width:40,height:40})})]},t)):0===K.length?(0,n.jsx)(_.Z,{children:(0,n.jsx)(z.Z,{colSpan:ex?6:em?7:8,align:"center",children:s&&X?"دانش آموزی در این کلاس با فیلتر انتخاب شده یافت نشد":"لطفا یک کلاس و تاریخ انتخاب کنید"})}):K.map(e=>{var t;return(0,n.jsxs)(_.Z,{sx:{backgroundColor:"present"===e.status?"rgba(76, 175, 80, 0.05)":"rgba(244, 67, 54, 0.05)",transition:"background-color 0.3s ease","&:hover":{backgroundColor:"present"===e.status?"rgba(76, 175, 80, 0.1)":"rgba(244, 67, 54, 0.1)"}},children:[(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(l.Z,{component:"img",src:e.photo||"/no-avatar.png",alt:e.fullName,onError:e=>{e.currentTarget.src="/no-avatar.png"},sx:{width:ex?32:40,height:ex?32:40,borderRadius:"50%",objectFit:"cover",border:"1px solid #ddd"}})}),(0,n.jsx)(z.Z,{align:"center",sx:{fontSize:ex?"0.8rem":"1rem"},children:e.fullName}),!ex&&(0,n.jsx)(z.Z,{align:"center",children:e.nationalCode}),!em&&(0,n.jsx)(z.Z,{align:"center",children:e.className}),!q&&(0,n.jsx)(z.Z,{align:"center",sx:{fontSize:ex?"0.7rem":"0.85rem",maxWidth:300,whiteSpace:"normal"},children:(0,n.jsx)("div",{dangerouslySetInnerHTML:{__html:(null===(t=e.subjects_attended)||void 0===t?void 0:t.replace(/\|/g,"<br/>").replace(/✓/g,'<span style="color:green">✓</span>').replace(/✗/g,'<span style="color:red">✗</span>'))||"-"}})}),q&&(0,n.jsx)(z.Z,{align:"center",sx:{fontSize:ex?"0.8rem":"1rem"},children:e.subjectName||q.name}),(0,n.jsx)(z.Z,{align:"center",sx:{fontSize:ex?"0.8rem":"1rem"},children:(0,n.jsxs)(l.Z,{sx:{display:"flex",alignItems:"center",justifyContent:"center",gap:1},children:[(0,n.jsx)(A.Z,{fontSize:"small",color:"action"}),e.checkin_time||"-"]})}),(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(b.Z,{label:q?"present"===e.status?"حاضر":"غایب":e.present_count===e.total_subjects&&e.total_subjects>0?"حاضر":"غایب",color:q?"present"===e.status?"success":"error":e.present_count===e.total_subjects&&e.total_subjects>0?"success":"error",size:"small",variant:"outlined",sx:{fontWeight:"bold"},icon:q?"present"===e.status?(0,n.jsx)(M.Z,{fontSize:"small"}):(0,n.jsx)(F.Z,{fontSize:"small"}):e.present_count===e.total_subjects&&e.total_subjects>0?(0,n.jsx)(M.Z,{fontSize:"small"}):(0,n.jsx)(F.Z,{fontSize:"small"})})}),(0,n.jsx)(z.Z,{align:"center",children:(0,n.jsx)(f.Z,{color:q?"present"===e.status?"error":"success":e.present_count===e.total_subjects&&e.total_subjects>0?"error":"success",onClick:()=>eg(e),size:"small",sx:{border:"1px solid ".concat(q?"present"===e.status?eh.palette.error.main:eh.palette.success.main:e.present_count===e.total_subjects&&e.total_subjects>0?eh.palette.error.main:eh.palette.success.main),transition:"all 0.2s ease","&:hover":{backgroundColor:q?"present"===e.status?"rgba(244, 67, 54, 0.1)":"rgba(76, 175, 80, 0.1)":e.present_count===e.total_subjects&&e.total_subjects>0?"rgba(244, 67, 54, 0.1)":"rgba(76, 175, 80, 0.1)"}},children:q?"present"===e.status?(0,n.jsx)(F.Z,{fontSize:"small"}):(0,n.jsx)(M.Z,{fontSize:"small"}):e.present_count===e.total_subjects&&e.total_subjects>0?(0,n.jsx)(F.Z,{fontSize:"small"}):(0,n.jsx)(M.Z,{fontSize:"small"})})})]},e.nationalCode)})})]})}),K.length>0&&(0,n.jsxs)(l.Z,{sx:{p:ex?1:2,display:"flex",justifyContent:"space-between",borderTop:"1px solid ".concat(eh.palette.divider),flexDirection:ex?"column":"row",gap:ex?1:0},children:[(0,n.jsxs)(E.Z,{variant:"body2",color:"text.secondary",children:["تعداد: ",K.length," دانش آموز"]}),(0,n.jsxs)(E.Z,{variant:"body2",color:"text.secondary",align:ex?"left":"right",children:["present"===V?"حاضرین":"غایبین",": ",K.length," نفر"]})]})]}),(0,n.jsx)(N.Z,{open:eo.open,autoHideDuration:6e3,onClose:ef,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:(0,n.jsx)(o.Z,{onClose:ef,severity:eo.severity,variant:"filled",sx:{width:"100%"},children:eo.message})})]})}}},function(e){e.O(0,[6838,1349,8573,4424,1873,5325,2761,1893,2888,9774,179],function(){return e(e.s=74142)}),_N_E=e.O()}]);